pico-8 cartridge // http://www.pico-8.com
version 32
__lua__

function _draw()
	cls()
	update_part()
	draw_back()
	draw_map()
	draw_actors()
end

function draw_back()
	for p in all(back_part) do
		pset(p.x, p.y, p.c)
	end
end

function draw_actors()
	for a in all(actors) do
		if fget(a.sprite, 0) then -- x dependent animated
			a.sprite = a.sprite-a.sprite%2+a.x%2
		end
		spr(a.sprite, a.x, a.y)
	end
end

function draw_map()
	-- swap tiles for animations
	anim_t -= 1
	if anim_t == 0 then
		anim_t = 8
		anim_f = (anim_f + 1)%2
		for ix = 0,15 do
			for iy = 0,15 do
				local t = mget(ix,iy)
				if fget(t,7) then
					local b = t-t%2
					mset(ix,iy,t-t%2+anim_f)					
				end
			end
		end
	end
	map()
end

function update_part()
	-- Actually done during draw
	for p in all(back_part) do
		p.x += p.dx
		p.dy += 0.005 --grav
		p.dy = min(p.dy,1)
		p.y += p.dy
		if max(p.x,p.y) > 128 then
			del(back_part,p)
			add(back_part,new_back_part(0))
		end
	end
end

function _update()
	update_actors()
end

function update_actors()
	for a in all(actors) do
		-- Gravity
		a.dy = min(4,a.dy+0.25)
		-- Move. Doing multiple per frame.
		if max(abs(a.dx), abs(a.dy)) > 0 then
			local steps = 5
			for i = 0, steps do
				if check_collide(a.x + a.dx / steps, a.y-1) then
					a.dx = 0
				end
				if check_collide(a.x, a.y + a.dy / steps) then
					if a.dy > 1 then
						a.y = ceil(a.y/8) * 8
						a.on_floor = true
					end
					a.dy = 0
				end
				a.x += a.dx / steps
				a.y += a.dy / steps
			end
		end
		-- Friction
		a.dx *= 0.8
		printh(a.on_floor)
		a.logic(a)
	end
end

function player(actor)
	-- Logic for any player
	local p = actor.player
	local l = btn(0, p)
	local r = btn(1, p)
	--local u = btn(2, p)
	--local d = btn(3, p)
	--local o = btn(4, p)
	local x = btnp(5, p)
	local accel = .75
	local max = 4
	if l then
		actor.dx -= accel
	end
	if r then
		actor.dx += accel
	end
	if x then
		jump(actor)
	end
	--actor.dx = mid(-max,actor.dx,max)
end

function jump(actor)
	local jump = 4
	if actor.on_floor then
		actor.dy -= jump
		actor.on_floor = false
	end
end

function none(actor)
	-- Do nothing
end

function check_collide(x, y, w, h)
	local collide = false
	w = w or 8
	h = h or 8
	
 	for i = x, x+w, w do
		if fget(mget(i/8,y/8),0) or fget(mget(i/8,(y+h)/8),0) then
			collide = true
		end
	end

	for i = y, y+h, h do
		if fget(mget(x/8,i/8),0) or fget(mget((x+w)/8,i/8),0) then
			collide = true
		end
	end
	return collide
end

function init_back()
	back_part={}
	for i = 0,50 do
		add(back_part,new_back_part())
	end
end

function new_back_part(x)
 x = x or rnd(128)
	return part(x,rnd(128),rnd(2), rnd(.05)-.025, rnd({1,1,1,1,5,5,5,5,6,6,7}))
end

function part(x,y,dx,dy,c)
	local p = {}
	p.x=x
	p.y=y
	p.dx=dx
	p.dy=dy
	p.c=c
	return p
end

function init_map()
	ox=0
	oy=0
end

function new_actor(sprite, logic)
	local a = {}
	a.sprite = sprite
	a.logic = logic
	a.x = 0
	a.y = 0
	a.dx = 0
	a.dy = 0
	return a
end

function _init()
	anim_t = 8
	anim_f = 0
	init_back()
	init_map()
	local p0 = new_actor(2, player)
	p0.x = 10
	p0.y = 40
	p0.player = 0
	actors={p0}
end
__gfx__
00000000000000000000000000000000000000000000000000000000000000000777777054545454000000000000000000000000000000000000000000000000
00000000000000000006670000055500000000000000000000000000000000005666666745454545000000000000000000000000000000000000000000000000
00700700000000000066667000566700000000000000000000000000000000005666666754545454000000000000000000000000000000000000000000000000
00077000000000000561617000666670000000000000000000000000000000005666666745454545000000000000000000000000000000000000000000000000
00077000000000000566666005616160000000000000000000000000000000005666666754545454000000000000000000000000000000000000000000000000
007007000000000005d6dd5005d66650000000000000000000000000000000005666666745454545b0b0b0b00b0b0b0b00000000000000000000000000000000
000000000000000000d5d000005dd500000000000000000000000000000000005666666754545454303030303030303000000000000000000000000000000000
0000000000000000000dcc00000ccd00000000000000000000000000000000000555555045454545333333333333333300000000000000000000000000000000
00000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000006870000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000056667000068700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000057878000566670000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000056666000578780000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000028688000566660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000002880000082800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000002080000008200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000888880
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000880880
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000880880
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000888880
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e000e00060006000044000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
28e028e01c601c600000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88828880ccc1ccc00005460000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
088888000ccccc000055556000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0288820001ccc1000015556000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00288000001cc0000015555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00020000000100000001150000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0001010000000000010380800000000000010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000008080800000808080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0808080808080800000808080808080800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000707070707070707070707070800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000a0a0a000000000a0a0a00000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000909090000000009090900000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000909090000000009090900000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000080800000808000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
080000000000000a0a0000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0808080808080809090808080808080800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
